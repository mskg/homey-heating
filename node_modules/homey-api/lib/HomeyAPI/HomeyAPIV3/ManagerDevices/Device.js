'use strict';

const Util = require('../../../Util');
const Item = require('../Item');
const DeviceCapability = require('./DeviceCapability');

class Device extends Item {

  constructor(...props) {
    super(...props);

    // Set Capability Instances
    Object.defineProperty(this, '__capabilityInstances', {
      value: {},
      enumerable: false,
      writable: true,
    });
  }

  /**
   * Creates an {@link HomeyAPIV3.DeviceCapability} for realtime capability updates.
   * @param {string} capabilityId
   * @param {Function} listener
   * @param {number|boolean|string} listener.value
   * @returns {HomeyAPIV3.ManagerDevices.Device.DeviceCapability}
   * @function HomeyAPIV3.ManagerDevices.Device#makeCapabilityInstance
   * @example
   *
   *  const onOffInstance = device.makeCapabilityInstance('onoff', value => {
   *    console.log('Device onoff changed to:', value);
   *  });
   *
   * // Turn on
   * onOffInstance.setValue(true).catch(console.error);
   */
  makeCapabilityInstance(capabilityId, listener) {
    this.connect().catch(err => {
      this.__debug(err);
    });

    const instance = new DeviceCapability({
      listener,
      id: capabilityId,
      device: this,
    });

    instance.once('destroy', () => {
      this.__capabilityInstances[capabilityId] = this.__capabilityInstances[capabilityId] || [];
      this.__capabilityInstances[capabilityId] = this.__capabilityInstances[capabilityId].filter(i => i !== instance);

      if (this.__capabilityInstances[capabilityId].length === 0) {
        delete this.__capabilityInstances[capabilityId];
      }

      if (Object.keys(this.__capabilityInstances).length === 0) {
        this.__debug('No more Capability instances, disconnecting...');
        this.disconnect().catch(err => this.__debug(err));
      }
    });

    this.__capabilityInstances[capabilityId] = this.__capabilityInstances[capabilityId] || [];
    this.__capabilityInstances[capabilityId].push(instance);

    return instance;
  }

  /**
   * Sets a capability's value.
   * @param {object} opts
   * @param {string} opts.capabilityId
   * @param {number|boolean|string} opts.value
   * @param {object} [opts.opts]
   * @param {number} [opts.opts.duration]
   * @returns {Promise<void>}
   * @function HomeyAPIV3.ManagerDevices.Device#setCapabilityValue
   */
  async setCapabilityValue(options, ...args) {
    // Legacy compatibility from node-athom-api
    if (typeof options === 'string') {
      return this.setCapabilityValueLegacy(options, ...args);
    }

    return this.__setCapabilityValue(options);
  }

  async __setCapabilityValue({
    capabilityId,
    value,
    opts,
    transactionId = `homey-api-${Util.uuid()}`,
    transactionTime = Date.now(),
  }) {
    return this.manager.setCapabilityValue({
      deviceId: this.id,
      capabilityId,
      value,
      opts,
      transactionId,
      transactionTime,
    });
  }

  async setCapabilityValueLegacy(capabilityId, value, opts) {
    return this.__setCapabilityValue({
      capabilityId,
      value,
      opts,
    });
  }

  onReconnect() {
    if (Object.keys(this.__capabilityInstances).length > 0) {
      // Get the device's latest values
      // TODO: Optimize this with `getDevices()` when >1 device has >0 capability instances.
      this.manager.getDevice({
        id: this.id,
      }).then(async device => {
        Object.entries(this.__capabilityInstances).forEach(([capabilityId, capabilityInstance]) => {
          const value = device.capabilitiesObj
            ? typeof device.capabilitiesObj[capabilityId] !== 'undefined'
              ? device.capabilitiesObj[capabilityId].value
              : null
            : null;

          capabilityInstance.__onCapabilityValue({
            capabilityId,
            value,
            transactionId: Util.uuid(),
          });
        });
      })
        // eslint-disable-next-line no-console
        .catch(err => this.__debug(`Device[${this.id}].onReconnectError:`, err));
    }
  }

  async getZone() {
    return this.homey.zones.getZone({
      id: this.zone,
    });
  }

  async getDriver() {
    return this.homey.drivers.getDriver({
      id: this.driverId,
    });
  }

  async getLogs() {
    const logs = await this.homey.insights.getLogs();
    return Object.values(logs)
      .filter(log => log.ownerUri === this.uri)
      .reduce((result, log) => ({
        ...result,
        [log.id]: log,
      }), {});
  }

  async getFlows() {
    const flows = await this.homey.flow.getFlows();
    return Object.values(flows)
      .filter(flow => {
        if (flow.trigger && flow.trigger.id.startsWith(this.uri)) return true;
        if (Array.isArray(flow.conditions) && flow.conditions.some(card => card.id.startsWith(this.uri))) return true;
        if (Array.isArray(flow.actions) && flow.actions.some(card => card.id.startsWith(this.uri))) return true;

        // TODO: Zone cards
        // TODO: Subzone cards

        return false;
      })
      .reduce((result, flow) => ({
        ...result,
        [flow.id]: flow,
      }), {});
  }

  async getAdvancedFlows() {
    const advancedFlows = await this.homey.flow.getAdvancedFlows();
    return Object.values(advancedFlows)
      .filter(advancedFlow => {
        return Object.values(advancedFlow.cards)
          .filter(card => ['trigger', 'condition', 'action'].includes(card.type))
          .some(card => {
            if (card.id.startsWith(this.uri)) return true;

            // TODO: Zone cards
            // TODO: Subzone cards
            return false;
          });
      })
      .reduce((result, advancedFlow) => ({
        ...result,
        [advancedFlow.id]: advancedFlow,
      }), {});
  }

  static transformGet(item) {
    item = super.transformGet(item);

    delete item.driverUri;

    if (item.capabilitiesObj) {
      for (const capabilityObj of Object.values(item.capabilitiesObj)) {
        if (capabilityObj.lastUpdated) {
          capabilityObj.lastUpdated = new Date(capabilityObj.lastUpdated);
        }
      }
    }

    return item;
  }

}

module.exports = Device;
